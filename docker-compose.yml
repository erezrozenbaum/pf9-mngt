services:
  db:
    image: postgres:16
    container_name: pf9_db
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports:
      - "5432:5432"
    volumes:
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql:ro
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped

  pgadmin:
    image: dpage/pgadmin4
    container_name: pf9_pgadmin
    environment:
      PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL:-admin@pf9-mgmt.local}
      PGADMIN_DEFAULT_PASSWORD: "${PGADMIN_PASSWORD:?ERROR: PGADMIN_PASSWORD must be set in .env}"
    ports:
      - "8080:80"
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    depends_on:
      - db
    restart: unless-stopped

  pf9_api:
    build:
      context: ./api
    container_name: pf9_api
    environment:
      PF9_DB_HOST: db
      PF9_DB_PORT: "5432"
      PF9_DB_NAME: ${POSTGRES_DB}
      PF9_DB_USER: ${POSTGRES_USER}
      PF9_DB_PASSWORD: ${POSTGRES_PASSWORD}

      # === Platform9 / OpenStack auth (non-secret fields) ===
      PF9_AUTH_URL: ${PF9_AUTH_URL}
      PF9_USER_DOMAIN: ${PF9_USER_DOMAIN:-Default}
      PF9_PROJECT_NAME: ${PF9_PROJECT_NAME:-service}
      PF9_PROJECT_DOMAIN: ${PF9_PROJECT_DOMAIN:-Default}
      PF9_REGION_NAME: ${PF9_REGION_NAME:-region-one}
      PF9_USERNAME: ${PF9_USERNAME}
      PF9_PASSWORD: ${PF9_PASSWORD}

      # === LDAP Authentication Configuration ===
      LDAP_SERVER: ldap
      LDAP_PORT: "389"
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD}
      LDAP_BASE_DN: ${LDAP_BASE_DN:-dc=pf9mgmt,dc=local}
      LDAP_USER_DN: ${LDAP_USER_DN:-ou=users,dc=pf9mgmt,dc=local}
      LDAP_GROUP_DN: ${LDAP_GROUP_DN:-ou=groups,dc=pf9mgmt,dc=local}

      # === JWT Configuration ===
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      JWT_ALGORITHM: ${JWT_ALGORITHM:-HS256}
      JWT_ACCESS_TOKEN_EXPIRE_MINUTES: ${JWT_ACCESS_TOKEN_EXPIRE_MINUTES:-480}
      JWT_REFRESH_TOKEN_EXPIRE_DAYS: ${JWT_REFRESH_TOKEN_EXPIRE_DAYS:-30}

      # === Logging Configuration ===
      LOG_FILE: /app/logs/pf9_api.log

      # === Authentication Control ===
      ENABLE_AUTHENTICATION: ${ENABLE_AUTHENTICATION:-true}
      DEFAULT_ADMIN_USER: ${DEFAULT_ADMIN_USER:-admin}
      DEFAULT_ADMIN_PASSWORD: ${DEFAULT_ADMIN_PASSWORD}

      # === Restore Feature ===
      RESTORE_ENABLED: ${RESTORE_ENABLED:-false}
      RESTORE_DRY_RUN: ${RESTORE_DRY_RUN:-false}
      RESTORE_CLEANUP_VOLUMES: ${RESTORE_CLEANUP_VOLUMES:-false}

      # === Service User (shared with snapshot worker) ===
      SNAPSHOT_SERVICE_USER_EMAIL: ${SNAPSHOT_SERVICE_USER_EMAIL:-}
      SNAPSHOT_SERVICE_USER_PASSWORD: ${SNAPSHOT_SERVICE_USER_PASSWORD:-}
      SNAPSHOT_SERVICE_USER_DOMAIN: ${SNAPSHOT_SERVICE_USER_DOMAIN:-default}
      SNAPSHOT_PASSWORD_KEY: ${SNAPSHOT_PASSWORD_KEY:-}
      SNAPSHOT_USER_PASSWORD_ENCRYPTED: ${SNAPSHOT_USER_PASSWORD_ENCRYPTED:-}

      # === SSH Log Collection ===
      SSH_PF9_HOSTS: ${SSH_PF9_HOSTS:-}
      PF9_SSH_USER: ${PF9_SSH_USER:-pf9}
      PF9_SSH_PASSWORD: ${PF9_SSH_PASSWORD:-}
      PF9_SSH_KEY_PATH: ${PF9_SSH_KEY_PATH:-}

      # === Email Notifications ===
      SMTP_ENABLED: ${SMTP_ENABLED:-false}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USE_TLS: ${SMTP_USE_TLS:-true}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM_ADDRESS: ${SMTP_FROM_ADDRESS:-pf9-mgmt@example.com}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Platform9 Management}

      # === Connection Pool Tuning ===
      DB_POOL_MIN_CONN: ${DB_POOL_MIN_CONN:-2}
      DB_POOL_MAX_CONN: ${DB_POOL_MAX_CONN:-10}

      # === Demo Mode ===
      DEMO_MODE: ${DEMO_MODE:-false}

      # === Ops Copilot ===
      COPILOT_BACKEND: ${COPILOT_BACKEND:-builtin}
      COPILOT_OLLAMA_URL: ${COPILOT_OLLAMA_URL:-http://host.docker.internal:11434}
      COPILOT_OLLAMA_MODEL: ${COPILOT_OLLAMA_MODEL:-llama3}
      COPILOT_OPENAI_API_KEY: ${COPILOT_OPENAI_API_KEY:-}
      COPILOT_OPENAI_MODEL: ${COPILOT_OPENAI_MODEL:-gpt-4o-mini}
      COPILOT_ANTHROPIC_API_KEY: ${COPILOT_ANTHROPIC_API_KEY:-}
      COPILOT_ANTHROPIC_MODEL: ${COPILOT_ANTHROPIC_MODEL:-claude-sonnet-4-20250514}
      COPILOT_REDACT_SENSITIVE: ${COPILOT_REDACT_SENSITIVE:-true}
    ports:
      - "8000:8000"
    volumes:
      - app_logs:/app/logs
      - ./monitoring/cache:/app/monitoring/cache:ro
      - ${PF9_REPORTS_DIR:-./reports}:/mnt/reports:ro
      - ./api/static:/app/static
      - ./notifications/templates:/app/notification_templates:ro
    depends_on:
      - db
      - ldap
    restart: unless-stopped

  pf9_ui:
    build:
      context: ./pf9-ui
    container_name: pf9_ui
    ports:
      - "5173:5173"
    depends_on:
      - pf9_api
    restart: unless-stopped

  pf9_monitoring:
    build:
      context: ./monitoring
    container_name: pf9_monitoring
    environment:
      # Comma-separated list of PF9 host IPs to scrape metrics from
      PF9_HOSTS: ${PF9_HOSTS:-localhost}
      # Cache TTL in seconds for metrics collection
      METRICS_CACHE_TTL: ${METRICS_CACHE_TTL:-60}
      # Logging
      LOG_FILE: /app/logs/pf9_monitoring.log
    ports:
      - "8001:8001"
    volumes:
      - "./monitoring/cache:/tmp/cache"
      - "./logs:/app/logs"
    depends_on:
      - pf9_api
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  snapshot_worker:
    build:
      context: .
      dockerfile: snapshots/Dockerfile
    container_name: pf9_snapshot_worker
    environment:
      PF9_AUTH_URL: ${PF9_AUTH_URL}
      PF9_USER_DOMAIN: ${PF9_USER_DOMAIN:-Default}
      PF9_PROJECT_NAME: ${PF9_PROJECT_NAME:-service}
      PF9_PROJECT_DOMAIN: ${PF9_PROJECT_DOMAIN:-Default}
      PF9_REGION_NAME: ${PF9_REGION_NAME:-region-one}
      PF9_USERNAME: ${PF9_USERNAME}
      PF9_PASSWORD: ${PF9_PASSWORD}
      PF9_DB_HOST: db
      PF9_DB_PORT: ${PF9_DB_PORT:-5432}
      PF9_DB_NAME: ${PF9_DB_NAME:-pf9_mgmt}
      PF9_DB_USER: ${PF9_DB_USER:-pf9}
      PF9_DB_PASSWORD: ${PF9_DB_PASSWORD}
      SNAPSHOT_PASSWORD_KEY: ${SNAPSHOT_PASSWORD_KEY}
      SNAPSHOT_USER_PASSWORD_ENCRYPTED: ${SNAPSHOT_USER_PASSWORD_ENCRYPTED}
      SNAPSHOT_SERVICE_USER_EMAIL: ${SNAPSHOT_SERVICE_USER_EMAIL:-}
      SNAPSHOT_SERVICE_USER_PASSWORD: ${SNAPSHOT_SERVICE_USER_PASSWORD:-}
      SNAPSHOT_SCHEDULER_ENABLED: ${SNAPSHOT_SCHEDULER_ENABLED:-true}
      POLICY_ASSIGN_INTERVAL_MINUTES: ${POLICY_ASSIGN_INTERVAL_MINUTES:-60}
      AUTO_SNAPSHOT_INTERVAL_MINUTES: ${AUTO_SNAPSHOT_INTERVAL_MINUTES:-60}
      POLICY_ASSIGN_CONFIG: ${POLICY_ASSIGN_CONFIG:-/app/snapshots/snapshot_policy_rules.json}
      AUTO_SNAPSHOT_MAX_SIZE_GB: ${AUTO_SNAPSHOT_MAX_SIZE_GB:-260}
      RVTOOLS_INTEGRATION_ENABLED: ${RVTOOLS_INTEGRATION_ENABLED:-true}
      COMPLIANCE_REPORT_ENABLED: ${COMPLIANCE_REPORT_ENABLED:-true}
      COMPLIANCE_REPORT_INTERVAL_MINUTES: ${COMPLIANCE_REPORT_INTERVAL_MINUTES:-1440}
      COMPLIANCE_REPORT_SLA_DAYS: ${COMPLIANCE_REPORT_SLA_DAYS:-2}
      POLICY_ASSIGN_MERGE_EXISTING: ${POLICY_ASSIGN_MERGE_EXISTING:-true}
      POLICY_ASSIGN_DRY_RUN: ${POLICY_ASSIGN_DRY_RUN:-false}
      POLICY_ASSIGN_SYNC_POLICY_SETS: ${POLICY_ASSIGN_SYNC_POLICY_SETS:-true}
      AUTO_SNAPSHOT_MAX_NEW: ${AUTO_SNAPSHOT_MAX_NEW:-200}
      AUTO_SNAPSHOT_DRY_RUN: ${AUTO_SNAPSHOT_DRY_RUN:-false}
    volumes:
      - app_logs:/app/logs
      - ${PF9_REPORTS_DIR:-./reports}:/mnt/reports
    depends_on:
      - db
    restart: always

  # LDAP Directory Service for Authentication
  ldap:
    image: osixia/openldap:latest
    container_name: pf9_ldap
    environment:
      LDAP_ORGANISATION: "${LDAP_ORGANISATION:-Platform9 Management}"
      LDAP_DOMAIN: "${LDAP_DOMAIN:-pf9mgmt.local}"
      LDAP_ADMIN_PASSWORD: '${LDAP_ADMIN_PASSWORD}'
      LDAP_CONFIG_PASSWORD: "${LDAP_CONFIG_PASSWORD}"
      LDAP_READONLY_USER: "${LDAP_READONLY_USER:-true}"
      LDAP_READONLY_USER_PASSWORD: "${LDAP_READONLY_PASSWORD}"
      LDAP_TLS_VERIFY_CLIENT: "never"
      LDAP_ADMIN_DN: "cn=admin,${LDAP_BASE_DN:-dc=pf9mgmt,dc=local}"
      LDAP_BASE_DN: "${LDAP_BASE_DN:-dc=pf9mgmt,dc=local}"
    ports:
      - "${LDAP_PORT:-389}:389"
      - "${LDAP_SSL_PORT:-636}:636"
    volumes:
      - ldap_data:/var/lib/ldap
      - ldap_config:/etc/ldap/slapd.d
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "sh", "-c", "ldapsearch -x -D \"$$LDAP_ADMIN_DN\" -w \"$$LDAP_ADMIN_PASSWORD\" -H ldap://localhost -b $$LDAP_BASE_DN -s base"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Email Notification Worker
  notification_worker:
    build:
      context: ./notifications
    container_name: pf9_notification_worker
    environment:
      PF9_DB_HOST: db
      PF9_DB_PORT: "5432"
      PF9_DB_NAME: ${POSTGRES_DB}
      PF9_DB_USER: ${POSTGRES_USER}
      PF9_DB_PASSWORD: ${POSTGRES_PASSWORD}
      SMTP_ENABLED: ${SMTP_ENABLED:-false}
      SMTP_HOST: ${SMTP_HOST:-}
      SMTP_PORT: ${SMTP_PORT:-587}
      SMTP_USE_TLS: ${SMTP_USE_TLS:-true}
      SMTP_USERNAME: ${SMTP_USERNAME:-}
      SMTP_PASSWORD: ${SMTP_PASSWORD:-}
      SMTP_FROM_ADDRESS: ${SMTP_FROM_ADDRESS:-pf9-mgmt@example.com}
      SMTP_FROM_NAME: ${SMTP_FROM_NAME:-Platform9 Management}
      NOTIFICATION_POLL_INTERVAL_SECONDS: ${NOTIFICATION_POLL_INTERVAL_SECONDS:-120}
      NOTIFICATION_DIGEST_ENABLED: ${NOTIFICATION_DIGEST_ENABLED:-true}
      NOTIFICATION_DIGEST_HOUR_UTC: ${NOTIFICATION_DIGEST_HOUR_UTC:-8}
      NOTIFICATION_LOOKBACK_SECONDS: ${NOTIFICATION_LOOKBACK_SECONDS:-300}
      HEALTH_ALERT_THRESHOLD: ${HEALTH_ALERT_THRESHOLD:-50}
      LOG_FILE: /app/logs/pf9_notifications.log
    volumes:
      - app_logs:/app/logs
    depends_on:
      - db
    restart: unless-stopped

  # Database & LDAP Backup Worker
  backup_worker:
    build:
      context: ./backup_worker
    container_name: pf9_backup_worker
    environment:
      BACKUP_ENABLED: ${BACKUP_ENABLED:-true}
      DB_HOST: db
      DB_PORT: "5432"
      DB_NAME: ${POSTGRES_DB}
      DB_USER: ${POSTGRES_USER}
      DB_PASS: ${POSTGRES_PASSWORD}
      NFS_BACKUP_PATH: ${NFS_BACKUP_PATH:-/backups}
      POLL_INTERVAL: ${BACKUP_POLL_INTERVAL:-3600}
      # LDAP backup settings
      LDAP_HOST: ldap
      LDAP_PORT: "389"
      LDAP_BASE_DN: ${LDAP_BASE_DN:-dc=pf9mgmt,dc=local}
      LDAP_ADMIN_DN: "cn=admin,${LDAP_BASE_DN:-dc=pf9mgmt,dc=local}"
      LDAP_ADMIN_PASSWORD: ${LDAP_ADMIN_PASSWORD}
    volumes:
      - ${BACKUP_VOLUME:-./backups}:/backups
    depends_on:
      - db
      - ldap
    restart: unless-stopped

  # LDAP Administration Interface (Optional - can be disabled in production)
  phpldapadmin:
    image: osixia/phpldapadmin:latest
    container_name: pf9_ldap_admin
    environment:
      PHPLDAPADMIN_LDAP_HOSTS: ldap
      PHPLDAPADMIN_HTTPS: "false"
    ports:
      - "${LDAP_ADMIN_PORT:-8081}:80"
    depends_on:
      - ldap
    restart: unless-stopped

  # Operational Metering Worker
  metering_worker:
    build:
      context: ./metering_worker
    container_name: pf9_metering_worker
    environment:
      DB_HOST: db
      DB_PORT: "5432"
      DB_NAME: ${POSTGRES_DB}
      DB_USER: ${POSTGRES_USER}
      DB_PASS: ${POSTGRES_PASSWORD}
      MONITORING_URL: http://pf9_monitoring:8001
      API_URL: http://pf9_api:8000
      METERING_POLL_INTERVAL: ${METERING_POLL_INTERVAL:-60}
    depends_on:
      - db
      - pf9_monitoring
      - pf9_api
    restart: unless-stopped

  # Search Indexer Worker (Ops Assistant)
  search_worker:
    build:
      context: ./search_worker
    container_name: pf9_search_worker
    environment:
      DB_HOST: db
      DB_PORT: "5432"
      DB_NAME: ${POSTGRES_DB}
      DB_USER: ${POSTGRES_USER}
      DB_PASS: ${POSTGRES_PASSWORD}
      SEARCH_INDEX_INTERVAL: ${SEARCH_INDEX_INTERVAL:-300}
    depends_on:
      - db
    restart: unless-stopped

volumes:
  pgdata:
  pgadmin_data:
  ldap_data:
  ldap_config:
  app_logs:


